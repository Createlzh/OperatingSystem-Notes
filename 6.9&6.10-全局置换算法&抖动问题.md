# 6.9&6.10 全局置换算法&抖动问题

[TOC]

### 工作集页面置换算法

* 基本思想：将不在工作集时间区间`(t-△, t]`内的逻辑页面置换出去

* 实例：

  > ![工作集页面置换算法](.\pics\quanju1.png)
  >
  > * 即使没有发生缺页中断，还是有页被置换出去
  > * 当前在物理内存中放哪些页，取决于是否在工作集的时间窗口内

* 并不是发生缺页异常才置换出去，只要不在工作集内了就被置换出去

* 保证了物理内存中始终有足够多的页存在，给其他运行的程序提供更多的内存，在整个系统（多个程序）的层面上降低了缺页次数



### 缺页率页面置换算法

* **可变分配策略**：常驻集大小可变

  > 每个进程刚开始运行的时候，先根据程序大小分配一定数目的物理页面，然后在进程运行过程中，动态地调整常驻集的大小

  * 采用全局页面置换的方式：发生一个缺页中断时，被置换的页面可以是其它进程中的，**各个并发进程竞争地使用物理页面**

  * 优缺点：性能较好，但增加了系统开销

  * 具体实现：使用**缺页率算法(PFF, page fault frequency)**来动态调整常驻集的大小

  * 依据：缺页的频度

    > 缺页的次数越多意味着应该给这个程序分配更多的物理内存，如果缺页的次数很少，则说明分配的内存已经足够多了，应该压缩

* **缺页率**：`缺页次数/总内存访问次数` 或者 `缺页的平均时间间隔的倒数`

* 影响缺页率的因素：

  1. 页面置换算法

  2. 分配给该进程的物理页面数目

  3. 页面本身的大小

     > 如果页面自身更大，相应地缺页率肯定更低

  4. 程序本身的编写方法（局部性）

* **缺页率算法**

  > 个人思考：前面提到过"使用PPF动态调整常驻集大小"，但下文缺页率算法对应的课件以及老师讲解都使用的是“工作集”？
  >
  > * 工作集是一个人为设定的概念（区间长度delta可以人为界定），而常驻集是一个实际存在的概念（时刻t下常驻集是固定的）
  > * 如果动态地改变工作集置换算法中的区间长度，即动态调整delta从而调整工作集的同时，也就实际地改变了内存中的常驻集

  * 基本思想：动态地调整工作集的大小

    * 缺页率高，通过增加工作集来分配更多的物理页面
    * 缺页率低，通过减少工作集来减少它的物理页面数
    * 力图使每个程序的缺页率保存在一个合理范围

  * **调整工作集的方式**：调整工作集的`△`，也就是时间间隔

  * 算法：保持追踪缺失发生的概率

    * 当缺页在`tc`发生时，计算上次页缺失发生的时间`tl`与`tc`的差值`tc - tl`

      > `tc`即`t_current`，`tl`即`t_last`

    * 设置一个阈值`T`（window size）

      * 如果`tc - tl > T`则说明缺页率太低，从工作集中移除所有在`[tl, tc]`时间内没有被引用的项
      * 如果`tc - tl < T`则说明缺页率太高，增加缺失页到工作集中

  * 实例：

    > ![缺页率算法](.\pics\quanju2.png)



### 对比

* 页面置换时机：
  * `工作集页面置换算法`在每访问一个页都可能进行页面置换
  * `缺页率置换算法`只有在发生缺页时才可能进行页面置换

* 工作集：
  * `工作集页面置换算法`的影响工作集的区间长度即时间间隔长度不变
  * `缺页率置换算法`的工作集长度随着时间动态变化



### 抖动问题

* **抖动问题（thrashing）**：如果分配给一个进程的物理页面太少，不能包含整个工作集，即`常驻集`被`工作集`包含，那么进程将会造成很多缺页中断，需要频繁地在内存与外存之间替换页面，从而使得进程的运行速度变得很慢，我们把这种状态称为“**抖动**”
* **产生抖动的原因**：随着驻留内存的进程数目增加，分配个每个进程的物理页面数不断减少，缺页率不断上升，OS要选择一个适当的进程数目和进程需要的帧数，以在**并发水平和缺页率之间达到一个平衡**

* 解决抖动问题的方法：

  * **MPL**（Multiprogramming Level）：并发程序的数量

    > 随着并发程序数量的上升，`CPU Utilization`会先上升并在并发程序量为`Nmax`时达到最高值，随后不断下降，因为越来越多的缺页中断使得CPU不得不频繁做换入换出的工作

  * **MTBF**（mean time between page fault）：平均页缺失时间间隔

  * **PFST**（page fault service time）：页缺失服务时间（操作系统进行换入换出页的时间）

  * 调整`MPL`使得`MTBF/PFST=1`

  > ![抖动问题的解决](.\pics\thrashing.png)

